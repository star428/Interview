# golang 问题

## GPM协程调度

理解G，P，M，同时知道自旋线程和M0,G0即可

## 三色标定法

### Go1.3 之前标记-清除算法

需要STW（stop the world）

### Go1.5 三色标记加插入屏障/删除屏障

不STW执行三色标记法的问题：

1. 一个白色对象被黑色对象引用（白色对象挂在黑色底下）
2. 灰色对象与它之间的可达关系的白色对象遭到破坏（灰色对象对白色对象的引用遭到破坏）

同时满足上面两个条件就会导致对象丢失现象

为了减少STW的时间，引出了屏障机制

#### 屏障机制

基于强-弱三色不变式

1. 强：不允许黑色对象引用白色对象
2. 弱：黑色对象可以引用白色对象，前提是白色对象在灰色对象的引用范围中

**插入屏障：**A引用B时，自动将B变为灰色（栈上不适用插入屏障）

插入屏障问题：对于栈上数据需要扫描两次，以免在前一次当中有黑色元素引用白色元素

**删除屏障：**被删除的对象，如果自身是白色或者灰色，标记为灰色（堆栈共同使用这种方式）

删除屏障问题：精度较低，无论堆栈都需要两次甚至多次遍历才可以删除

### Go1.8 三色标记加混合写屏障

1. 将栈上可达对象全部标记为黑色
2. GC期间，任何栈上创建的新对象均为黑色
3. 被删除引用的对象标记为灰色
4. 被添加引用的对象标记为灰色
   **栈不启动混合写屏障**

GC什么时候会被触发？

1. 堆内存的分配达到控制器计算的触发堆大小，初始大小为GOGC，之后堆内存达到上一次的2倍时才会触发GC。
2. 一定时间触发，时间为2分钟，由runtime.forcegcperiod控制
